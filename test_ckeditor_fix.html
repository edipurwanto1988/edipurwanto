<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKEditor 5 Fix Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">CKEditor 5 Fix Verification</h1>
        
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Debug Information:</h2>
            <div id="debug-info" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm mb-6"></div>
            
            <h2 class="text-lg font-semibold mb-4">Test Editor:</h2>
            <textarea id="content" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="10" placeholder="Test content...">This is test content for CKEditor.</textarea>
        </div>
    </div>

    <script>
        // Debug logging function
        function debugLog(message) {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(`[CKEditor Fix Test] ${message}`);
        }

        // Simulate the fixed initialization process
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('=== CKEditor 5 Fix Verification ===');
            debugLog('DOM loaded, starting initialization...');
            debugLog('CKEditor Debug: Starting CKEditor initialization...');
            
            // Simulate the fixed loading process
            setTimeout(function() {
                debugLog('CKEditor Debug: Checking ClassicEditor availability...');
                
                if (typeof ClassicEditor !== 'undefined') {
                    debugLog('CKEditor Debug: ClassicEditor is available, proceeding with initialization...');
                    
                    const contentTextarea = document.querySelector('#content');
                    if (contentTextarea) {
                        debugLog('CKEditor Debug: Content textarea found, setting up editor...');
                        
                        // Hide original textarea
                        contentTextarea.style.display = 'none';
                        
                        // Create editor container
                        const editorContainer = document.createElement('div');
                        editorContainer.id = 'content-editor';
                        editorContainer.style.minHeight = '300px';
                        contentTextarea.parentNode.insertBefore(editorContainer, contentTextarea);
                        
                        ClassicEditor
                            .create(editorContainer, {
                                plugins: [
                                    'Heading',
                                    'Bold',
                                    'Italic',
                                    'Link',
                                    'BulletedList',
                                    'NumberedList',
                                    'Outdent',
                                    'Indent',
                                    'BlockQuote',
                                    'InsertTable',
                                    'Undo',
                                    'Redo',
                                    'GeneralHtmlSupport',
                                    'HtmlEmbed'
                                ],
                                toolbar: [
                                    'heading', '|',
                                    'bold', 'italic', '|',
                                    'link', 'bulletedList', 'numberedList', '|',
                                    'outdent', 'indent', '|',
                                    'blockQuote', 'insertTable', '|',
                                    'undo', 'redo'
                                ],
                                placeholder: 'Write your article content here...'
                            })
                            .then(editor => {
                                debugLog('✅ Editor was initialized successfully');
                                debugLog('CKEditor Debug: Loading CodeBox utility...');
                                
                                // Simulate CodeBox loading
                                const script = document.createElement('script');
                                script.textContent = `
                                    console.log('[CodeBox] Loading CodeBox utility...');
                                    window.initCodeBox = function(editor) {
                                        console.log('[CodeBox] CodeBox utility initialized for editor:', editor);
                                        return { success: true };
                                    };
                                    console.log('[CodeBox] CodeBox utility loaded successfully');
                                `;
                                script.onload = function() {
                                    debugLog('CKEditor Debug: CodeBox utility loaded, initializing...');
                                    
                                    try {
                                        if (typeof window.initCodeBox === 'function') {
                                            const codeBoxUtil = window.initCodeBox(editor);
                                            if (codeBoxUtil) {
                                                debugLog('✅ CodeBox utility initialized successfully');
                                            } else {
                                                debugLog('❌ Failed to initialize CodeBox utility');
                                            }
                                        } else {
                                            debugLog('❌ CodeBox utility not available after loading');
                                        }
                                    } catch (error) {
                                        debugLog('❌ Error initializing CodeBox: ' + error.message);
                                    }
                                };
                                document.head.appendChild(script);
                                
                                // Set initial content
                                editor.setData(contentTextarea.value);
                                
                                // Sync content
                                editor.model.document.on('change:data', () => {
                                    const data = editor.getData();
                                    contentTextarea.value = data;
                                });
                                
                                debugLog('✅ CKEditor setup complete with CodeBox integration');
                            })
                            .catch(error => {
                                debugLog('❌ Editor initialization error: ' + error.message);
                                debugLog('CKEditor Debug: Error details: ' + error.stack);
                                
                                // Show fallback textarea
                                contentTextarea.style.display = 'block';
                                contentTextarea.style.border = '2px solid #ef4444';
                                contentTextarea.title = 'CKEditor failed to load. Using fallback textarea.';
                            });
                    } else {
                        debugLog('❌ Content textarea not found');
                    }
                } else {
                    debugLog('❌ ClassicEditor is not available');
                    debugLog('CKEditor Debug: Possible causes:');
                    debugLog('- CKEditor CDN failed to load');
                    debugLog('- Network connectivity issues');
                    debugLog('- JavaScript errors preventing CKEditor loading');
                }
            }, 100);
        });
    </script>
</body>
</html>