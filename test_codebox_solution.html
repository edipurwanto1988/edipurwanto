<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKEditor 5 CodeBox Solution Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.css">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">CKEditor 5 CodeBox Solution Test</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Editor Section -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">CKEditor with CodeBox</h2>
                <div id="editor" class="min-h-[300px] border border-gray-300 rounded"></div>
                <p class="text-sm text-gray-600 mt-2">Look for the "Code Box" button in the toolbar</p>
            </div>
            
            <!-- Debug Section -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Debug Information</h2>
                <div id="debug-info" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs h-[300px] overflow-y-auto"></div>
            </div>
        </div>
        
        <!-- Test Section -->
        <div class="bg-white p-6 rounded-lg shadow mt-6">
            <h2 class="text-xl font-semibold mb-4">Test CodeBox Output</h2>
            <div id="test-output" class="border border-gray-300 rounded p-4 min-h-[200px]">
                <p class="text-gray-500">CodeBox output will appear here when you insert code boxes...</p>
            </div>
        </div>
    </div>

    <!-- Load CodeBox utility -->
    <script src="public/js/ckeditor/codebox.js"></script>
    
    <!-- Prism.js -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-php.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>

    <script>
        // Debug logging function
        function debugLog(message) {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(`[CodeBox Test] ${message}`);
        }

        // Test initialization
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('=== CKEditor 5 CodeBox Solution Test ===');
            debugLog('DOM loaded, starting tests...');
            
            // Test 1: Check dependencies
            debugLog('Checking dependencies...');
            debugLog(`ClassicEditor available: ${typeof ClassicEditor !== 'undefined'}`);
            debugLog(`CodeBox utility available: ${typeof window.initCodeBox !== 'undefined'}`);
            debugLog(`Prism.js available: ${typeof Prism !== 'undefined'}`);
            
            // Test 2: Initialize CKEditor
            debugLog('Initializing CKEditor...');
            ClassicEditor
                .create(document.querySelector('#editor'), {
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'link', 'blockQuote', '|',
                        'undo', 'redo'
                    ],
                    placeholder: 'Test the CodeBox functionality by clicking the Code Box button...',
                    htmlSupport: {
                        allow: [
                            {
                                name: /.*/,
                                attributes: true,
                                classes: true,
                                styles: true
                            }
                        ]
                    }
                })
                .then(editor => {
                    debugLog('✅ CKEditor initialized successfully');
                    
                    // Test 3: Initialize CodeBox utility
                    debugLog('Initializing CodeBox utility...');
                    if (typeof window.initCodeBox === 'function') {
                        const codeBoxUtil = window.initCodeBox(editor);
                        if (codeBoxUtil) {
                            debugLog('✅ CodeBox utility initialized successfully');
                            
                            // Test 4: Monitor editor content changes
                            editor.model.document.on('change:data', () => {
                                const data = editor.getData();
                                const testOutput = document.getElementById('test-output');
                                testOutput.innerHTML = data;
                                
                                // Re-initialize Prism for new content
                                if (window.Prism) {
                                    Prism.highlightAllUnder(testOutput);
                                }
                            });
                            
                            debugLog('✅ Content monitoring enabled');
                            
                        } else {
                            debugLog('❌ Failed to initialize CodeBox utility');
                        }
                    } else {
                        debugLog('❌ CodeBox utility not available');
                    }
                })
                .catch(error => {
                    debugLog(`❌ CKEditor initialization failed: ${error.message}`);
                });
            
            // Test 5: Copy button functionality
            debugLog('Setting up copy button test...');
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('copy-btn')) {
                    debugLog('Copy button clicked - testing functionality...');
                    try {
                        const codeBox = e.target.closest('.code-box');
                        if (codeBox) {
                            const code = codeBox.querySelector('pre').innerText;
                            await navigator.clipboard.writeText(code);
                            debugLog('✅ Copy functionality working');
                        }
                    } catch (error) {
                        debugLog(`❌ Copy functionality failed: ${error.message}`);
                    }
                }
            });
            
            // Test 6: Prism.js initialization
            debugLog('Initializing Prism.js...');
            window.addEventListener('DOMContentLoaded', () => {
                if (window.Prism) {
                    Prism.highlightAll();
                    debugLog('✅ Prism.js initialized');
                } else {
                    debugLog('❌ Prism.js not available');
                }
            });
            
            debugLog('=== Test initialization complete ===');
            debugLog('Instructions:');
            debugLog('1. Look for the "Code Box" button in the CKEditor toolbar');
            debugLog('2. Click it to open the language selection dialog');
            debugLog('3. Select a language and insert a code box');
            debugLog('4. Test the copy button functionality');
            debugLog('5. Check that syntax highlighting is applied');
        });
    </script>
</body>
</html>